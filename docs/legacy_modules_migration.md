# Dreaming & SoulManager è¿ç§»ä¸æ¼”è¿›æ–¹æ¡ˆ

åœ¨å¼•å…¥ **Letta (MemGPT)** æ¶æ„åï¼Œæˆ‘ä»¬ç°æœ‰çš„ä¸¤ä¸ªæ ¸å¿ƒ Python æ¨¡å— `dreaming.py` å’Œ `soul_manager.py` å°†é¢ä¸´ä¸åŒçš„å‘½è¿ã€‚

---

## 1. `dreaming.py` (Lumina çš„"æµ·é©¬ä½“")

**ç°çŠ¶**ï¼š
ç›®å‰å®ƒè´Ÿè´£ä¸¤ä¸ªæ ¸å¿ƒå¾ªç¯ï¼š

1.  **Reverie Cycle (Consolidation)**ï¼šå®šæœŸæ‰«æ `conversation_log`ï¼Œæå–å…³é”®ä¿¡æ¯å­˜å…¥ `episodic_memory`ã€‚
2.  **Soul Evolution**ï¼šå®šæœŸåˆ†æè®°å¿†ï¼Œé€šè¿‡ LLM è¯„ä¼°å¹¶æ›´æ–°æ€§æ ¼å‚æ•° (Big Five, PAD)ã€‚

**Letta å¼•å…¥åçš„å‘½è¿ï¼šğŸ—ï¸ è¢«åå™¬/é‡æ„**

- **Memory Consolidation (è®°å¿†æ•´åˆ)**ï¼š

  - âŒ **åºŸå¼ƒ**ï¼šLetta çš„æ ¸å¿ƒå–ç‚¹å°±æ˜¯**å®æ—¶**è®°å¿†ç®¡ç†ã€‚åœ¨å¯¹è¯è¿‡ç¨‹ä¸­ï¼ŒLetta ä¼šè‡ªå·±å†³å®š _"Wait, user mentioned he likes cats, I should record this"_ï¼Œå¹¶è°ƒç”¨ `core_memory_append`ã€‚
  - æ— éœ€å†å†™ä¸€ä¸ªç¦»çº¿çš„ "Dreaming" æœ‰æ¥æ‰«ææ—¥å¿—ï¼Œå› ä¸º Letta åœ¨"é†’ç€"çš„æ—¶å€™å°±å·²ç»æŠŠè¯¥è®°çš„éƒ½è®°äº†ã€‚

- **Soul Evolution (æ€§æ ¼æ¼”åŒ–)**ï¼š
  - âš ï¸ **ä¿ç•™é€»è¾‘ï¼Œæ”¹å˜è§¦å‘æ–¹å¼**ï¼šLetta æœ¬èº«ä¸å¸¦"æ€§æ ¼æ¼”åŒ–"åŠŸèƒ½ï¼ˆå®ƒåªè®°äº‹å®ï¼‰ã€‚
  - **æ–°è®¾è®¡**ï¼šæˆ‘ä»¬å°† `_analyze_soul_evolution` è¿™éƒ¨åˆ†é€»è¾‘å‰¥ç¦»å‡ºæ¥ï¼Œå˜æˆä¸€ä¸ª **Letta Tool (Function)**ã€‚
  - **åœºæ™¯**ï¼šæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ª Prompt æŒ‡ä»¤ç»™ Lettaï¼š\*"æ¯å½“å¤œæ·±äººé™ï¼ˆæ£€æµ‹åˆ°ç”¨æˆ·å¾ˆä¹…æ²¡è¯´è¯ï¼‰ï¼Œè¯·è°ƒç”¨ `evolve_personality` å·¥å…·ï¼Œå›é¡¾ä»Šå¤©çš„å¯¹è¯å¹¶åæ€ä½ çš„æˆé•¿ã€‚"

**ç»“è®º**ï¼š`dreaming.py` ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„åå°è¿›ç¨‹å°†æ¶ˆå¤±ã€‚å®ƒçš„åŠŸèƒ½å°†è¢«æ‹†è§£ä¸º Letta çš„ **Internal Monologue** (è®°å¿†) å’Œ **Custom Tool** (æ€§æ ¼æ¼”åŒ–)ã€‚

---

## 2. `soul_manager.py` (Lumina çš„"çµé­‚å‚æ•°")

**ç°çŠ¶**ï¼š
å®ƒç®¡ç†ä¸‰ä¸ª JSON æ–‡ä»¶ï¼š

1.  `config.json` (ç”¨æˆ·è®¾ç½®)
2.  `soul.json` (AI æ€§æ ¼ï¼šBig Five, Traits)
3.  `state.json` (æ¸¸æˆçŠ¶æ€ï¼šç¾ç»Šç­‰çº§, PAD, èƒ½é‡å€¼)

**Letta å¼•å…¥åçš„å‘½è¿ï¼šğŸ§¬ è¿›åŒ–ä¸º "Persona & State"**

Letta æœ‰ä¸¤ä¸ªæ¦‚å¿µï¼š**System Prompt** (Persona) å’Œ **Core Memory** (Block)ã€‚`soul_manager.py` å°†è´Ÿè´£æŠŠæˆ‘ä»¬çš„æ•°æ®æ˜ å°„åˆ°è¿™ä¸¤ä¸ªæ¦‚å¿µä¸Šã€‚

- **Persona (äººæ ¼è®¾å®š)**ï¼š

  - `soul.json` ä¸­çš„ `Traits` (å¦‚ "å‚²å¨‡", "æ¸©æŸ”") å°†ç›´æ¥æ¸²æŸ“è¿› Letta çš„ **System Instructions** å—ä¸­ã€‚
  - _å˜æ›´ç‚¹_ï¼š`SoulManager.render_system_prompt()` å°†ä¸å†ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²ç»™ OpenAIï¼Œè€Œæ˜¯ç”Ÿæˆç”¨äºåˆå§‹åŒ– Letta Agent çš„é…ç½®ã€‚

- **Core Memory (æ ¸å¿ƒå­˜å‚¨)**ï¼š
  - `state.json` ä¸­çš„ **GalGame æ•°å€¼** (ç¾ç»Šç­‰çº§ã€PAD å¿ƒæƒ…å€¼) å°†å­˜å‚¨åœ¨ Letta çš„ **Core Memory Block** åŒºåŸŸã€‚
  - **ä¼˜åŠ¿**ï¼šè¿™æ„å‘³ç€ LLM å¯ä»¥**ç›´æ¥è¯»å†™**è¿™äº›æ•°å€¼ï¼
    - ä»¥å‰ï¼šæˆ‘ä»¬éœ€è¦å†™æ­»é€»è¾‘ `if intimacy > 100: level_up()`ã€‚
    - ç°åœ¨ï¼šLetta å¯ä»¥æ€è€ƒ _"ç”¨æˆ·åˆšåˆšé€äº†æˆ‘ç¤¼ç‰©ï¼Œæˆ‘å¥½å¼€å¿ƒï¼Œæˆ‘è¦æŠŠç¾ç»Šå€¼åŠ  10 ç‚¹"_ï¼Œç„¶åè‡ªå·±è°ƒç”¨ `update_intimacy(+10)`ã€‚

**ç»“è®º**ï¼š`soul_manager.py` **å¿…é¡»ä¿ç•™**ã€‚å®ƒæ˜¯ Lumina ç‹¬ç‰¹çš„"æ¸¸æˆæ€§"æ‰€åœ¨ï¼ŒLetta åªæ˜¯åº•å±‚çš„é©±åŠ¨å¼•æ“ï¼ŒSoulManager å®šä¹‰äº†åœ¨è¿™ä¸ªå¼•æ“ä¸Šè·‘çš„æ˜¯"åŸç¾"è¿˜æ˜¯"çœŸç”±ç†"ã€‚

---

## 3. æ¶æ„è¿ç§»è·¯çº¿å›¾

1.  **Phase 1 (æ•°æ®åŒæ­¥)**ï¼š

    - ä¿®æ”¹ `SoulManager`ï¼Œåœ¨å¯åŠ¨æ—¶é€šè¿‡ API è¯»å– Letta çš„ `Core Memory`ï¼ŒæŠŠå…¶ä¸­çš„ mood/intimacy çŠ¶æ€åŒæ­¥å›æœ¬åœ° `state.json` (ä½œä¸ºå¤‡ä»½)ã€‚

2.  **Phase 2 (å·¥å…·åŒ–)**ï¼š

    - æŠŠ `Dreaming.py` ä¸­çš„ `accumulate_for_evolution` é€»è¾‘åˆ æ‰ã€‚
    - åœ¨ Letta ä¸­æ³¨å†Œ `update_personality_traits` å’Œ `reflect_on_day` ä¸¤ä¸ªå·¥å…·ã€‚

3.  **Phase 3 (å…¨é¢æ¥ç®¡)**ï¼š
    - Lumina åç«¯ä¸å†ç›´æ¥ä¿®æ”¹ `state.json`ã€‚æ‰€æœ‰çš„çŠ¶æ€å˜æ›´ï¼ˆå¥½æ„Ÿåº¦å¢å‡ã€å¿ƒæƒ…å˜åŒ–ï¼‰å…¨éƒ¨ç”± Letta åœ¨**å¯¹è¯æ€è€ƒè¿‡ç¨‹ä¸­**åˆ¤å®šå¹¶æ‰§è¡Œã€‚Lumina å‰ç«¯åªè´Ÿè´£**åªè¯»**æ˜¾ç¤ºè¿™äº›æ•°å€¼ã€‚
