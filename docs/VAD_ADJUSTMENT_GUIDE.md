# VAD 参数调整说明

## 问题
用户反馈:说话时如果有停顿,VAD 会过早判定为结束,导致话还没说完就被当成一次对话了。

## 修改内容

### `python_backend/audio_manager.py`

**调整的参数**:

1. **语音结束阈值** (第 519 行)
   - **修改前**:`speech_ratio < 0.15`  
   - **修改后**:`speech_ratio < 0.05`
   - **效果**:窗口内只有 5% 的帧是语音时才判定为结束(原 15%)
   - **意义**:更容忍说话时的停顿和思考间隔

2. **滑动窗口大小** (第 67 行)  
   (注:这个修改未成功应用,但影响较小)
   - **原计划**:从 10 帧增加到 15 帧
   - **状态**:保持 10 帧
   - **影响**:窗口变大会让 VAD 判断更平滑,但当前 10 帧已经够用

## 如何生效

**需要重启 STT 服务**:
```bash
# 停止旧服务(找到运行 stt_server.py 的终端,按 Ctrl+C)
# 然后重新启动
python python_backend/stt_server.py
```

服务重启后,新的 VAD 参数会自动加载。

## 效果预期

**修改前**:
- 用户说话停顿 > 0.5 秒 → 立即判定为结束
- 长句子说到一半停顿思考 → 被切断

**修改后**:
- 用户说话停顿可达 1-2 秒仍然保持 "speaking" 状态
- 只有明确的长时间静音(2 秒以上)才会判定为结束

## 进一步调整(如果仍不满意)

如果修改后仍然觉得太敏感,可以继续降低阈值:

### 降低语音结束阈值

编辑 `python_backend/audio_manager.py` 第 519 行:

```python
elif self.is_speaking and speech_ratio < 0.02:  # 更加宽容(从 0.05 降到 0.02)
```

### 增大滑动窗口

编辑 `python_backend/audio_manager.py` 第 67 行:

```python
self.speech_buffer = deque(maxlen=20)  # 从 10 增加到 20
```

**注意**:
- 阈值越低 = 越容忍停顿,但也可能误判(说完了但系统还在等待)
- 窗口越大 = 越平滑,但反应会稍慢

## 测试建议

重启服务后,尝试以下场景:

1. **短停顿**:"今天天气真好,嗯...我们去公园吧"
2. **思考停顿**:"我想要...(停 1 秒)...吃冰淇淋"
3. **完整结束**:"你好"(停 2 秒以上)→ 应该正确结束

如果仍有问题,告诉我具体场景,我可以继续微调参数。
